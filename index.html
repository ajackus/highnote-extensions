<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- adding bootstrap.css and the needed styling -->
        <title>HighNote Pricing</title>
        <link href="style.css" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

        <!-- jQuery library -->
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.js"></script>

        <!-- Latest compiled JavaScript -->
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
        <!-- Adding HTML5.js -->
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
        
        
        <script type="text/javascript" src="https://js.stripe.com/v3/">
        </script>
        
        
        <script type="text/javascript" src="http://malsup.github.io/jquery.form.js"></script>
        <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.js"></script>
        
        
        <!-- Setting the stripe publishable key.-->
        <script>

            jQuery.validator.setDefaults({
                errorClass: "text-danger",
                errorElement: "small"
            });

            // Replace with your own publishable key: https://dashboard.stripe.com/test/apikeys
            var PUBLISHABLE_KEY = 'pk_test_51INXAGBz1bb2lqfxfi5wTT2TJvE53Shs91B5cEkGJrak7GPyfy4bTMJrrgcBnj3fi4H5fopwG55f8vRa9kL3iYIY00Ep7QDtah';
            // Replace with the domain you want your users to be redirected back to after payment
            var DOMAIN = location.href.replace(/[^/]*$/, '');
      
            if (PUBLISHABLE_KEY === 'pk_test_51INXAGBz1bb2lqfxfi5wTT2TJvE53Shs91B5cEkGJrak7GPyfy4bTMJrrgcBnj3fi4H5fopwG55f8vRa9kL3iYIY00Ep7QDtah') {
              console.log(
                'Replace the hardcoded publishable key with your own publishable key: https://dashboard.stripe.com/test/apikeys'
              );
            }
      
            var stripe = Stripe(PUBLISHABLE_KEY);
      
            // Handle any errors from Checkout
            var handleResult = function (result) {
              if (result.error) {
                var displayError = document.getElementById('error-message');
                displayError.textContent = result.error.message;
              }
            };

            $(document).ready(function() {

                $("#subscribe-form").validate({
                    rules: {
                        first_name: "required",
                        last_name: "required",
                        custom_info: 'required',
                        email: {
                            required: true,
                            // Specify that email should be validated
                            // by the built-in "email" rule
                            email: true
                        }
                    }
                });

                function formValidationCheck(form) {
                    // Checking form has passed the validation.
                    if (!$(form).valid()) {
                        return false;
                    }
                    $(".alert-danger").hide();
                    $('.subscribe_process').show();
                }
                $("#subscribe-form").on('submit', function(e) {
                    // form validation
                    formValidationCheck(this);
                    if(!$(this).valid()){
                        return false;
                    }
                    e.preventDefault();
                    var priceId = 'price_1JluHmBz1bb2lqfxfkcemXMO';
                    var items = [{ price: 'subscription', quantity: 1 }];
                    var highnote_heard_from = document.getElementById("custom_info").value;
                    var email = document.getElementById("email").value;
                    var first_name = document.getElementById("first_name").value;
                    var last_name = document.getElementById("last_name").value;
                    var referral = new URLSearchParams(location.search).get('REFERRALCODE')
                    let baseBackendURL = 'http://54.219.68.186/api/v1/get-checkout-session'
                    baseBackendURL = `${baseBackendURL}?first_name=${first_name}&last_name=${last_name}&email=${email}&highnote_heard_from=${highnote_heard_from}`
                    if(referral) baseBackendURL = `${baseBackendURL}&referral_code=${referral}`
                    fetch(baseBackendURL,{
                      method: 'GET',
                      headers: {
                        'Accept': 'application/json, text/plain, */*',
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Bearer sk_test_51INXAGBz1bb2lqfxeSOTJkBHTV9hNfj8W0vLP8wtZArCplgFTMY1yjjuFNLfNsn0upvjzyIpRjmJ2G2KbN7mYSjU00QN4fhUhX'
                      }
                    }).then(function(response){
                      return response.json();
                    }).then(function(session){
                      return stripe.redirectToCheckout({ sessionId: session.id });
                    }).then(handleResult)
                })
            })

        </script>
    </head>
    <body>
        <div class="navbar navbar-static-top">
            <div class="container">
                <div class="navbar-header">          
                    <div class="h1"></div>
                </div>
            </div>
        </div>
        <div id="container" class="checkout container">                        

            <div class="row">		
                <div class="col-sm-7" id="checkout_info">   
                    <form id="subscribe-form">
                        <!-- Add the needed fields in the form-->
                        <h3 class="page-header">Basic Information</h3>
                        <div class="row">                   
                            <div class="col-sm-8">
                                <div class="form-group">
                                    <label for="customer[email]">Email</label>
                                    <input id="email" type="text"
                                        class="form-control"
                                        name="customer[email]"
                                        maxlength=50
                                        data-rule-required="true" data-rule-email="true" 
                                        data-msg-required="Please enter your email address" 
                                        data-msg-email="Please enter a valid email address"
                                    >
                                    <small for="customer[email]" class="text-danger"></small>
                                </div>
                            </div>                   
                        </div>
                        <div class="row">                   
                            <div class="col-sm-8">
                                <div class="form-group">
                                    <label for="customer[first_name]">First Name</label>
                                    <input id='first_name' type="text" class="form-control" name="customer[first_name]" 
                                        maxlength=50 required data-msg-required="Cannot be blank"
                                    >
                                    <small for="customer[first_name]" class="text-danger"></small>
                                </div>
                            </div>                   
                        </div>
                        <div class="row">                   
                            <div class="col-sm-8">
                                <div class="form-group">
                                    <label for="customer[last_name]">Last Name</label>
                                    <input id='last_name' type="text" class="form-control" name="customer[last_name]"
                                        maxlength=50 required data-msg-required="Cannot be blank"
                                    >
                                    <small for="customer[last_name]" class="text-danger"></small>
                                </div>
                            </div>                   
                        </div>
                        <div class="row">                   
                            <div class="col-sm-8">
                                <div class="form-group">
                                    <label for="customer[custom_info]">How did you hear about HighNote?</label>
                                    <input id="custom_info" type="text"
                                        class="form-control"
                                        name="customer[custom_info]"
                                        maxlength=50
                                        required data-msg-required="Cannot be blank"
                                    >
                                    <small for="customer[custom_info]" class="text-danger"></small>
                                </div>
                            </div>                   
                        </div>
                        <p><input type="submit" class="btn btn-success btn-lg pull-left" value="Subscribe Now for 299.88/year">&nbsp;&nbsp;&nbsp;&nbsp;
                            <span class="subscribe_process process" style="display:none;">Processing&hellip;</span>
                            <small class="alert-danger text-danger"></small>
                        </p>
                    </form>
                </div>
            </div>
        </div>
        <br><br>
    </body>
</html>